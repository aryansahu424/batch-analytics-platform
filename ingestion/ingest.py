import os
import random
import logging
from datetime import datetime, timedelta
from pathlib import Path
import pandas as pd
import time
import argparse

# ----------------------------
# Configuration
# ----------------------------
MAX_RETRIES = 3
RETRY_DELAY_SECONDS = 2
RECORDS_PER_DAY = 500  # Adjust as needed

BASE_DIR = Path(__file__).resolve().parent.parent
RAW_DATA_DIR = BASE_DIR / "data" / "raw"
LOG_DIR = BASE_DIR / "logs"
LOG_DIR.mkdir(exist_ok=True)

# ----------------------------
# Logging Configuration
# ----------------------------
logging.basicConfig(
    filename=LOG_DIR / "ingestion.log",
    level=logging.INFO,
    format="%(asctime)s - %(levelname)s - %(message)s",
)

# ----------------------------
# Synthetic Dimension Values
# ----------------------------
CHANNELS = [
    {"channel_key": 1, "channel_name": "Credit Card", "fee_percent": 2.5},
    {"channel_key": 2, "channel_name": "Debit Card", "fee_percent": 1.0},
    {"channel_key": 3, "channel_name": "UPI", "fee_percent": 0.5},
    {"channel_key": 4, "channel_name": "Net Banking", "fee_percent": 1.5},
]

CUSTOMER_CITY_TUPLES = [
    (1,2),(2,2),(3,2),(4,1),(5,3),(6,4),(7,1),(8,3),(9,1),(10,3),(11,4),(12,2),(13,3),(14,4),(15,1),(16,2),(17,2),(18,3),(19,4),(20,3),(21,1),(22,3),(23,2),(24,1),(25,2),(26,2),(27,1),(28,2),(29,4),(30,2),(31,1),(32,3),(33,1),(34,2),(35,4),(36,3),(37,1),(38,1),(39,1),(40,2),(41,3),(42,3),(43,1),(44,4),(45,3),(46,3),(47,1),(48,2),(49,1),(50,2),(51,2),(52,3),(53,1),(54,3),(55,4),(56,2),(57,3),(58,4),(59,3),(60,1),(61,4),(62,1),(63,2),(64,1),(65,4),(66,2),(67,3),(68,1),(69,3),(70,4),(71,4),(72,4),(73,2),(74,4),(75,3),(76,3),(77,2),(78,1),(79,4),(80,1),(81,3),(82,2),(83,4),(84,3),(85,3),(86,1),(87,4),(88,3),(89,1),(90,1),(91,1),(92,3),(93,3),(94,3),(95,1),(96,2),(97,3),(98,1),(99,3),(100,2),(101,4),(102,1),(103,4),(104,4),(105,2),(106,1),(107,1),(108,4),(109,4),(110,1),(111,3),(112,4),(113,4),(114,1),(115,3),(116,4),(117,2),(118,4),(119,2),(120,2),(121,3),(122,2),(123,2),(124,3),(125,1),(126,1),(127,3),(128,2),(129,4),(130,2),(131,3),(132,4),(133,4),(134,4),(135,4),(136,1),(137,3),(138,4),(139,1),(140,3),(141,1),(142,1),(143,4),(144,1),(145,2),(146,2),(147,1),(148,4),(149,1),(150,4),(151,1),(152,1),(153,4),(154,2),(155,3),(156,2),(157,2),(158,2),(159,4),(160,1),(161,2),(162,3),(163,1),(164,4),(165,4),(166,4),(167,3),(168,2),(169,3),(170,2),(171,2),(172,4),(173,1),(174,1),(175,4),(176,4),(177,3),(178,4),(179,1),(180,4),(181,1),(182,3),(183,4),(184,3),(185,4),(186,1),(187,2),(188,4),(189,2),(190,3),(191,1),(192,4),(193,3),(194,3),(195,2),(196,3),(197,2),(198,2),(199,1),(200,3),(201,3),(202,1),(203,2),(204,3),(205,1),(206,2),(207,1),(208,1),(209,2),(210,4),(211,3),(212,2),(213,2),(214,2),(215,2),(216,4),(217,2),(218,3),(219,2),(220,2),(221,3),(222,2),(223,2),(224,4),(225,3),(226,4),(227,3),(228,3),(229,1),(230,3),(231,2),(232,1),(233,3),(234,3),(235,3),(236,3),(237,1),(238,2),(239,2),(240,1),(241,2),(242,2),(243,4),(244,4),(245,1),(246,3),(247,4),(248,1),(249,2),(250,2),(251,3),(252,2),(253,4),(254,3),(255,2),(256,4),(257,4),(258,1),(259,1),(260,2),(261,2),(262,4),(263,1),(264,1),(265,1),(266,3),(267,2),(268,1),(269,1),(270,3),(271,1),(272,2),(273,3),(274,3),(275,1),(276,1),(277,1),(278,1),(279,1),(280,4),(281,3),(282,4),(283,4),(284,3),(285,4),(286,4),(287,1),(288,3),(289,4),(290,3),(291,3),(292,3),(293,3),(294,4),(295,1),(296,1),(297,3),(298,2),(299,3),(300,1),(301,4),(302,2),(303,3),(304,3),(305,1),(306,2),(307,2),(308,3),(309,4),(310,3),(311,1),(312,1),(313,1),(314,1),(315,3),(316,4),(317,3),(318,4),(319,3),(320,3),(321,4),(322,3),(323,3),(324,4),(325,3),(326,1),(327,2),(328,2),(329,3),(330,3),(331,3),(332,2),(333,3),(334,1),(335,4),(336,3),(337,3),(338,1),(339,2),(340,3),(341,3),(342,3),(343,1),(344,4),(345,3),(346,4),(347,4),(348,4),(349,4),(350,3),(351,3),(352,3),(353,3),(354,2),(355,3),(356,4),(357,2),(358,4),(359,4),(360,1),(361,1),(362,4),(363,2),(364,2),(365,4),(366,3),(367,1),(368,1),(369,1),(370,4),(371,3),(372,1),(373,4),(374,2),(375,3),(376,3),(377,4),(378,1),(379,2),(380,4),(381,3),(382,3),(383,4),(384,3),(385,2),(386,1),(387,3),(388,2),(389,2),(390,3),(391,1),(392,3),(393,4),(394,2),(395,3),(396,4),(397,3),(398,2),(399,1),(400,3),(401,1),(402,1),(403,4),(404,3),(405,2),(406,2),(407,4),(408,4),(409,4),(410,3),(411,3),(412,1),(413,2),(414,2),(415,2),(416,2),(417,1),(418,1),(419,3),(420,1),(421,1),(422,2),(423,4),(424,2),(425,3),(426,3),(427,4),(428,3),(429,1),(430,3),(431,1),(432,4),(433,3),(434,3),(435,4),(436,2),(437,4),(438,3),(439,4),(440,3),(441,3),(442,4),(443,4),(444,1),(445,1),(446,4),(447,3),(448,4),(449,3),(450,2),(451,1),(452,4),(453,4),(454,2),(455,4),(456,2),(457,2),(458,1),(459,4),(460,2),(461,3),(462,2),(463,1),(464,3),(465,4),(466,1),(467,2),(468,4),(469,3),(470,4),(471,3),(472,2),(473,3),(474,1),(475,4),(476,1),(477,3),(478,2),(479,2),(480,1),(481,2),(482,3),(483,2),(484,3),(485,4),(486,2),(487,3),(488,3),(489,3),(490,3),(491,3),(492,2),(493,3),(494,1),(495,1),(496,4),(497,1),(498,2),(499,1),(500,2),(501,1),(502,2),(503,1),(504,3),(505,1),(506,4),(507,1),(508,3),(509,2),(510,4),(511,3),(512,2),(513,4),(514,3),(515,1),(516,1),(517,3),(518,2),(519,2),(520,4),(521,3),(522,1),(523,4),(524,3),(525,1),(526,4),(527,3),(528,2),(529,3),(530,4),(531,4),(532,2),(533,1),(534,4),(535,2),(536,2),(537,2),(538,2),(539,2),(540,3),(541,1),(542,4),(543,4),(544,1),(545,3),(546,2),(547,3),(548,2),(549,1),(550,1),(551,4),(552,2),(553,1),(554,3),(555,4),(556,2),(557,1),(558,2),(559,2),(560,3),(561,3),(562,1),(563,1),(564,4),(565,2),(566,1),(567,4),(568,3),(569,3),(570,3),(571,3),(572,3),(573,3),(574,2),(575,1),(576,4),(577,3),(578,4),(579,2),(580,3),(581,1),(582,4),(583,1),(584,4),(585,2),(586,3),(587,1),(588,3),(589,2),(590,3),(591,4),(592,2),(593,3),(594,4),(595,3),(596,3),(597,1),(598,1),(599,3),(600,4),(601,3),(602,3),(603,1),(604,4),(605,4),(606,4),(607,2),(608,3),(609,3),(610,4),(611,2),(612,1),(613,1),(614,3),(615,1),(616,4),(617,1),(618,3),(619,4),(620,2),(621,3),(622,4),(623,2),(624,1),(625,1),(626,3),(627,1),(628,4),(629,4),(630,2),(631,4),(632,4),(633,4),(634,3),(635,1),(636,3),(637,1),(638,1),(639,1),(640,3),(641,1),(642,1),(643,2),(644,1),(645,2),(646,1),(647,4),(648,3),(649,3),(650,3),(651,4),(652,1),(653,1),(654,3),(655,3),(656,3),(657,1),(658,3),(659,4),(660,2),(661,4),(662,1),(663,3),(664,1),(665,4),(666,1),(667,1),(668,1),(669,1),(670,1),(671,2),(672,4),(673,2),(674,3),(675,2),(676,3),(677,1),(678,4),(679,1),(680,3),(681,2),(682,2),(683,4),(684,1),(685,2),(686,3),(687,1),(688,1),(689,1),(690,1),(691,3),(692,2),(693,1),(694,3),(695,3),(696,2),(697,1),(698,3),(699,1),(700,2),(701,3),(702,1),(703,2),(704,3),(705,3),(706,4),(707,3),(708,3),(709,4),(710,1),(711,1),(712,2),(713,2),(714,2),(715,1),(716,4),(717,3),(718,3),(719,3),(720,2),(721,2),(722,3),(723,2),(724,1),(725,3),(726,2),(727,2),(728,1),(729,3),(730,4),(731,3),(732,1),(733,4),(734,4),(735,3),(736,4),(737,3),(738,3),(739,3),(740,3),(741,4),(742,1),(743,1),(744,3),(745,4),(746,1),(747,4),(748,2),(749,1),(750,4),(751,3),(752,4),(753,4),(754,4),(755,3),(756,4),(757,4),(758,1),(759,3),(760,1),(761,2),(762,3),(763,4),(764,1),(765,4),(766,1),(767,3),(768,1),(769,4),(770,2),(771,2),(772,4),(773,1),(774,2),(775,1),(776,1),(777,4),(778,3),(779,1),(780,2),(781,1),(782,4),(783,4),(784,1),(785,1),(786,2),(787,2),(788,3),(789,1),(790,4),(791,3),(792,3),(793,3),(794,2),(795,2),(796,3),(797,3),(798,2),(799,1),(800,4),(801,2),(802,2),(803,3),(804,3),(805,3),(806,3),(807,4),(808,1),(809,2),(810,1),(811,2),(812,3),(813,3),(814,2),(815,2),(816,1),(817,1),(818,2),(819,4),(820,2),(821,2),(822,1),(823,2),(824,2),(825,2),(826,2),(827,1),(828,3),(829,4),(830,1),(831,3),(832,4),(833,4),(834,3),(835,1),(836,1),(837,3),(838,4),(839,4),(840,4),(841,3),(842,3),(843,1),(844,2),(845,3),(846,2),(847,4),(848,3),(849,1),(850,4),(851,3),(852,4),(853,1),(854,1),(855,4),(856,1),(857,4),(858,4),(859,2),(860,4),(861,4),(862,3),(863,3),(864,3),(865,4),(866,2),(867,2),(868,1),(869,4),(870,4),(871,3),(872,1),(873,4),(874,3),(875,3),(876,2),(877,2),(878,1),(879,1),(880,1),(881,4),(882,3),(883,1),(884,2),(885,2),(886,1),(887,3),(888,4),(889,4),(890,2),(891,3),(892,3),(893,1),(894,1),(895,4),(896,4),(897,1),(898,4),(899,3),(900,3),(901,1),(902,2),(903,4),(904,4),(905,2),(906,3),(907,1),(908,4),(909,2),(910,1),(911,1),(912,2),(913,3),(914,4),(915,4),(916,2),(917,2),(918,4),(919,1),(920,4),(921,3),(922,2),(923,2),(924,2),(925,3),(926,1),(927,2),(928,3),(929,1),(930,4),(931,4),(932,3),(933,3),(934,3),(935,1),(936,2),(937,2),(938,4),(939,3),(940,3),(941,2),(942,2),(943,3),(944,3),(945,4),(946,3),(947,4),(948,4),(949,2),(950,3),(951,3),(952,4),(953,4),(954,1),(955,4),(956,3),(957,2),(958,3),(959,4),(960,2),(961,2),(962,3),(963,4),(964,4),(965,2),(966,3),(967,3),(968,4),(969,3),(970,3),(971,1),(972,3),(973,1),(974,1),(975,2),(976,2),(977,2),(978,1),(979,4),(980,4),(981,4),(982,1),(983,1),(984,4),(985,4),(986,3),(987,4),(988,4),(989,1),(990,3),(991,4),(992,3),(993,4),(994,1),(995,1),(996,1),(997,2),(998,2),(999,1),(1000,4)
]

CUSTOMER_CITY_MAP = dict(CUSTOMER_CITY_TUPLES)

# Generate a customer -> home city mapping
NUM_CUSTOMERS = 1000  # Should match your customer_key range

def generate_synthetic_transactions(process_date: datetime, num_records: int):
    """Generate synthetic transactional data for a given date."""

    records = []

    for i in range(num_records):
        transaction_id = f"T{process_date.strftime('%Y%m%d')}{i:05d}"
        customer_key = random.randint(1, NUM_CUSTOMERS)
        channel = random.choice(CHANNELS)
        city = CUSTOMER_CITY_MAP[customer_key]
        amount = round(random.uniform(10, 1000), 2)
        status = random.choices(["success", "failed"], weights=[0.9, 0.1])[0]
        processing_time = round(random.uniform(0.5, 5.0), 2)

        record = {
            "transaction_id": transaction_id,
            "date_key": int(process_date.strftime("%Y%m%d")),
            "customer_key": customer_key,
            "channel_key": channel["channel_key"],
            "city_key": city,
            "amount": amount,
            "status": status,
            "processing_time": processing_time,
        }

        records.append(record)

    return pd.DataFrame(records)


def save_transactions(df: pd.DataFrame, process_date: datetime):
    """Save transactions to partitioned folder structure."""

    year = process_date.strftime("%Y")
    month = process_date.strftime("%m")
    day = process_date.strftime("%d")

    output_dir = RAW_DATA_DIR / year / month / day
    output_dir.mkdir(parents=True, exist_ok=True)

    output_file = output_dir / "transactions.csv"

    df.to_csv(output_file, index=False)
    print("Saving to:", output_dir)
    return output_file


def run_ingestion():
    """Main ingestion logic with retry."""

    parser = argparse.ArgumentParser()
    parser.add_argument("--date", help="YYYY-MM-DD", type=str)
    args = parser.parse_args()

    if args.date:
        process_date = datetime.strptime(args.date, "%Y-%m-%d")
    else:
        process_date = datetime.now() - timedelta(days=1)

    attempt = 0
    while attempt < MAX_RETRIES:
        try:
            logging.info(f"Starting ingestion for {process_date.date()}")

            df = generate_synthetic_transactions(
                process_date, RECORDS_PER_DAY
            )

            output_file = save_transactions(df, process_date)

            logging.info(
                f"Ingestion successful | Date: {process_date.date()} | "
                f"Records: {len(df)} | File: {output_file}"
            )

            print(f"✅ Successfully ingested {len(df)} records.")
            return

        except Exception as e:
            attempt += 1
            logging.error(
                f"Attempt {attempt} failed for {process_date.date()} | Error: {str(e)}"
            )

            if attempt < MAX_RETRIES:
                time.sleep(RETRY_DELAY_SECONDS)
            else:
                logging.critical(
                    f"Ingestion failed after {MAX_RETRIES} attempts "
                    f"for {process_date.date()}"
                )
                print("❌ Ingestion failed after maximum retries.")
                raise


if __name__ == "__main__":
    run_ingestion()
